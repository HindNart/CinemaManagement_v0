<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/css/filmStyle.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
	    document.addEventListener("DOMContentLoaded", function () {
	        var modalToggleButtons = document.querySelectorAll('.schedule-time-item');
	    });

        document.addEventListener("DOMContentLoaded", function () {
            let listChoosen = document.getElementById("seat-chosens");
            let moneyCount = document.getElementById("moneyCount");
            let totalAmount = 0;
            
           
            
            function addSeat(button) {
                var chairValue = button.value;
                var chairID = button.getAttribute('chairID');
                var price = button.getAttribute('chairPrice');
                if (button.classList.contains("choosen-seat")) {
                    alert("Ghế này đã được đặt!");
                    return;
                }
                
                var chairType = button.classList.contains("normal-seat") ? "normal" :
                    button.classList.contains("vip-seat") ? "vip" :
                    button.classList.contains("couple-seat") ? "couple" : null;
    				var chairPrice = parseInt(price) ;

                // Kiểm tra xem ghế đã được chọn hay chưa
                var existingSeats = listChoosen.querySelectorAll(".seat-chosen");
                for (var i = 0; i < existingSeats.length; i++) {
                    if (existingSeats[i].textContent === chairValue) {
                        alert("Ghế này đã được chọn!");
                        return;
                    }
                }
                
                // Them id vao list
                if (listIdChair.value) {
                    listIdChair.value += ',' + chairID;
                } else {
                    listIdChair.value = chairID;
                }
             // Cập nhật tổng số tiền
                totalAmount += chairPrice;
                moneyCount.value = totalAmount;


             	// Thêm lớp để thay đổi màu nút ghế
             	
            	button.classList.add("selected-seat");
                // Tạo một phần tử mới để chứa thông tin ghế
                let seat = document.createElement("div");
                seat.className = "seat-chosen";
                seat.textContent = chairValue;
                listChoosen.appendChild(seat);
                
                seat.addEventListener("click", function () {
                    listChoosen.removeChild(seat);

                    totalAmount -= chairPrice;
                    moneyCount.value = totalAmount;
                    button.classList.remove("selected-seat");
                    // Xóa chairID khỏi listIdChair
                    let ids = listIdChair.value.split(',');
                    ids = ids.filter(id => id !== chairID);
                    listIdChair.value = ids.join(',');
                });
            }
            
            // Gán hàm addSeat cho các nút ghế
            var seatButtons = document.querySelectorAll(".normal-seat, .vip-seat, .couple-seat");
            seatButtons.forEach(button => {
                button.addEventListener("click", function () {
                    addSeat(button);
                });
            });
        });
        function loadContent(fragment) {
            fetch(fragment)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('content').innerHTML = data;
                })
                .catch(error => console.error('Error loading content:', error));
        }
     // Hàm để lấy ngày hiện tại và định dạng theo YYYY-MM-DD
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0 nên phải +1
            const day = String(today.getDate()).padStart(2, '0');

            const formattedDate = `${year}-${month}-${day}`;

            // Gán giá trị này vào thuộc tính value của input
            document.getElementById('currentDate').value = formattedDate;
        }

        // Gọi hàm khi trang được tải
        window.onload = setCurrentDate;
    </script>
</head>
<body>
    <div class="container">
                	<div class="buy-title">
                        <p><b>Mua vé xem phim</b></p>
                    </div>
    			<div class="buy-section">
                        <div class="buy-ticket">
                            <div class="seat-section">
                               <div class="seat-row"> 
								    <div th:each="chair : ${chairs}">
								        <div  th:if="${chair.loaiGhe.getLoaiGhe() == 'normal' and chair.hangGhe == 'A' and chair.trangThai == 0}">
								        	<input type="button" th:value="${chair.hangGhe} + ${chair.gheSo}"  class="choosen-seat"/> 
								        </div>
								        <div th:if="${chair.loaiGhe.getLoaiGhe() == 'normal' and chair.hangGhe == 'A' and chair.trangThai == 1}">
										    <input onclick="addSeat(this)" type="button" 
										           th:value="${chair.hangGhe} + ${chair.gheSo}" 
										           th:attr="chairPrice=${chair.loaiGhe.getGia}, 
										           chairID=${chair.idGhe}" 
										           class="normal-seat"/>
										</div>

								    </div>
								</div>
                                <div class="seat-row">
                                    <div th:each="chair : ${chairs}">
								        <div>
								        	<input th:if="${chair.loaiGhe.getLoaiGhe() == 'normal' and chair.hangGhe == 'B' and chair.trangThai == 0}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="choosen-seat"/> 
								            <input th:if="${chair.loaiGhe.getLoaiGhe() == 'normal' and chair.hangGhe == 'B' and chair.trangThai == 1}" th:attr="chairPrice=${chair.loaiGhe.getGia}, 
										           chairID=${chair.idGhe}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="normal-seat"/>
								        </div>
								    </div>

                                </div>
                                <div class="seat-row">
                                    <div th:each="chair : ${chairs}">
								        <div>								        	
								        	<input th:if="${chair.loaiGhe.getLoaiGhe() == 'vip' and chair.hangGhe == 'C' and chair.trangThai == 0}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="choosen-seat"/> 
								            <input th:if="${chair.loaiGhe.getLoaiGhe() == 'vip' and chair.hangGhe == 'C' and chair.trangThai == 1}" th:attr="chairPrice=${chair.loaiGhe.getGia}, 
										           chairID=${chair.idGhe}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="vip-seat"/>
								        </div>
								    </div>

                                </div>
                                <div class="seat-row">
                                    <div th:each="chair : ${chairs}">
								        <div>								        	
								        	<input th:if="${chair.loaiGhe.getLoaiGhe() == 'vip' and chair.hangGhe == 'D' and chair.trangThai == 0}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="choosen-seat"/> 
								            <input th:if="${chair.loaiGhe.getLoaiGhe() == 'vip' and chair.hangGhe == 'D' and chair.trangThai == 1}" th:attr="chairPrice=${chair.loaiGhe.getGia}, 
										           chairID=${chair.idGhe}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="vip-seat"/>
								        </div>
								    </div>
                                </div>
                                <div class="seat-row center-item">
                                	<div th:each="chair : ${chairs}">
								        <div>
								        	<input th:if="${chair.loaiGhe.getLoaiGhe() == 'couple' and chair.hangGhe == 'E' and chair.trangThai == 0}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="choosen-seat"/> 
								            <input th:if="${chair.loaiGhe.getLoaiGhe() == 'couple' and chair.hangGhe == 'E' and chair.trangThai == 1}" th:attr="chairPrice=${chair.loaiGhe.getGia}, 
										           chairID=${chair.idGhe}" onclick="addSeat(this)" type="button" th:value="${chair.hangGhe} + ${chair.gheSo}" class="couple-seat"/>
								        </div>
								    </div>
                                </div>
                                <div class="seat-details flex">
                                    <div class="seat-details-item">
                                        <div class="flex al-center">
                                            <div class="seat-black"></div>
                                            <p>Đã đặt</p>
                                        </div>
                                        <div class="flex al-center">
                                            <div class="seat-red"></div>
                                            <p>Ghế vip</p>
                                        </div>
                                    </div>
                                    <div class="seat-details-item">
                                        <div class="flex al-center">
                                            <div class="chosen"></div>
                                            <p>Đang chọn</p>
                                        </div>
                                        <div class="flex al-center">
                                            <div class="couple"></div>
                                            <p>Ghế đôi</p>
                                        </div>
                                    </div>
                                    <div class="seat-details-item">
                                        <div class="flex al-center">
                                            <div class="normal"></div>
                                            <p>Ghế thường</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="ticket-details">     
                                <p class="ageFilm margin-tb-10">P</p><input type="text" disabled th:value="${movie.tenPhim}" style="display:inline;">
                                <p style="color: rgb(220, 137, 35);">
                                <span th:text="${sche.ngayChieu}"></span>
                                <span> • <span th:text="${sche.thoigianBD}"> </span> ~ <span th:text="${sche.thoigianKT}"></span> • Phòng chiếu <span th:text="${sche.phongChieu.idPhong}"></span> <span th:text="${sche.phongChieu.loaiPhong}"></span>  </span></p>
                                <div class="seat-chose flex spc-btw">
                                    <p class="mb-2">Chỗ ngồi</p>
                                    <div id="seat-chosens" class=" flex spc-btw">
                                    </div>
                                </div>
                                <form th:action="@{/saveTicket}" th:object="${ticket}" method="POST">
	                                <div class="flex spc-btw ">
	                                    <div class="money">
	                                        <p>Tạm tính</p>
	                                        <input type="text" name="gia" id="moneyCount" readonly/>                                        
		                                    <input type="hidden" th:value="${account.email}" th:field="*{taiKhoan}" readonly/>
		                                    <input type="hidden" th:field="*{lichChieu}" th:value="${sche.idLichChieu}"/>
		                                    <input type="text" th:field="*{ghe}" id="listIdChair"/>
		                                    <input type="hidden" th:field="*{thoigianMua}" id="currentDate"readonly/>
	                                    </div>
	                                    <div class="">
	                                        <input type="submit" class="btn btn-primary pay-ticket" value="Mua vé"/>
	                                    </div>	                                
	                                </div>
    							</form>
                            </div>
                        </div>
                        
                    </div>
                 </div>
	             
</body>
</html>